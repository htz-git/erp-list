# ERP跨境电商管理系统 - 数据库设计文档

## 一、数据库设计思路

### 1.1 设计原则

1. **微服务数据库隔离**：每个微服务使用独立的数据库，实现数据隔离
2. **领域驱动设计**：按照业务领域划分数据库
3. **数据一致性**：通过分布式事务或最终一致性保证
4. **可扩展性**：表结构设计支持业务扩展
5. **性能优化**：合理使用索引，避免过度设计

### 1.2 数据库划分

- **erp_user**：用户服务数据库（用户、角色、权限）
- **erp_order**：订单服务数据库（订单、订单明细）
- **erp_pay**：支付服务数据库（支付记录、支付方式）
- **erp_promotion**：促销服务数据库（促销活动、优惠券）
- **erp_purchase**：采购服务数据库（采购单、供应商）
- **erp_refund**：退款服务数据库（退款申请、退款记录）
- **erp_replenishment**：补货服务数据库（补货单、库存预警）

### 1.3 通用字段设计

所有表都包含以下通用字段：
- `id`：主键，自增
- `create_time`：创建时间
- `update_time`：更新时间
- `deleted`：逻辑删除标记（0-未删除，1-已删除）

## 二、各模块数据库设计

### 2.1 用户服务（erp_user）

#### 设计思路
- 用户基础信息管理
- 角色权限管理
- 用户登录认证

#### 核心表
1. **用户表（user）**：存储用户基本信息
2. **角色表（role）**：存储角色信息
3. **权限表（permission）**：存储权限信息
4. **用户角色关联表（user_role）**：用户和角色的多对多关系
5. **角色权限关联表（role_permission）**：角色和权限的多对多关系

### 2.2 订单服务（erp_order）

#### 设计思路
- 订单生命周期管理
- 订单状态流转
- 订单明细管理

#### 核心表
1. **订单表（order）**：存储订单主信息
2. **订单明细表（order_item）**：存储订单商品明细
3. **订单状态变更记录表（order_status_log）**：记录订单状态变更历史

### 2.3 支付服务（erp_pay）

#### 设计思路
- 支付方式管理
- 支付记录管理
- 支付状态跟踪

#### 核心表
1. **支付记录表（payment）**：存储支付记录
2. **支付方式表（payment_method）**：存储支付方式配置
3. **支付流水表（payment_flow）**：记录支付流水

### 2.4 促销服务（erp_promotion）

#### 设计思路
- 促销活动管理
- 优惠券管理
- 促销规则配置

#### 核心表
1. **促销活动表（promotion）**：存储促销活动信息
2. **优惠券表（coupon）**：存储优惠券信息
3. **用户优惠券表（user_coupon）**：用户领取的优惠券
4. **促销规则表（promotion_rule）**：促销规则配置

### 2.5 采购服务（erp_purchase）

#### 设计思路
- 采购单管理
- 供应商管理
- 采购流程跟踪

#### 核心表
1. **采购单表（purchase_order）**：存储采购单信息
2. **采购明细表（purchase_item）**：存储采购商品明细
3. **供应商表（supplier）**：存储供应商信息
4. **采购状态记录表（purchase_status_log）**：记录采购状态变更

### 2.6 退款服务（erp_refund）

#### 设计思路
- 退款申请管理
- 退款审核流程
- 退款记录跟踪

#### 核心表
1. **退款申请表（refund_application）**：存储退款申请信息
2. **退款记录表（refund_record）**：存储退款记录
3. **退款原因表（refund_reason）**：退款原因配置

### 2.7 补货服务（erp_replenishment）

#### 设计思路
- 补货单管理
- 库存预警
- 补货计划

#### 核心表
1. **补货单表（replenishment_order）**：存储补货单信息
2. **补货明细表（replenishment_item）**：存储补货商品明细
3. **库存预警表（inventory_alert）**：库存预警信息
4. **补货计划表（replenishment_plan）**：补货计划

## 三、表关系设计

### 3.1 用户-订单关系
- 用户表（user） ← 订单表（order）：一对多
- 通过 `user_id` 外键关联

### 3.2 订单-支付关系
- 订单表（order） ← 支付记录表（payment）：一对多
- 通过 `order_id` 外键关联

### 3.3 订单-促销关系
- 订单表（order） ← 促销活动表（promotion）：多对多
- 通过中间表关联

### 3.4 采购-供应商关系
- 供应商表（supplier） ← 采购单表（purchase_order）：一对多
- 通过 `supplier_id` 外键关联

### 3.5 订单-退款关系
- 订单表（order） ← 退款申请表（refund_application）：一对多
- 通过 `order_id` 外键关联

## 四、索引设计

### 4.1 主键索引
- 所有表的主键 `id` 自动创建主键索引

### 4.2 外键索引
- 所有外键字段创建索引，提高关联查询性能

### 4.3 业务索引
- 常用查询字段创建索引（如：订单号、用户ID、创建时间等）
- 状态字段创建索引（如：订单状态、支付状态等）

## 五、数据一致性策略

### 5.1 分布式事务
- 使用 Seata 分布式事务框架
- 保证跨服务的数据一致性

### 5.2 最终一致性
- 通过消息队列实现最终一致性
- 使用补偿机制处理异常情况

### 5.3 数据同步
- 通过事件驱动实现数据同步
- 使用消息队列传递事件

## 六、性能优化建议

1. **分库分表**：当数据量增大时，考虑分库分表
2. **读写分离**：主从复制，读写分离
3. **缓存策略**：热点数据使用 Redis 缓存
4. **索引优化**：定期分析索引使用情况，优化索引
5. **查询优化**：避免全表扫描，使用合适的查询条件

